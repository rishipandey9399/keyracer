<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Key Racer - Typing Lessons</title>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9511160987539177"
     crossorigin="anonymous"></script>
    <link rel="stylesheet" href="styles/style.css">
    <link rel="stylesheet" href="styles/lessons.css">
    <link rel="stylesheet" href="styles/keyboard-links.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="racing-car sports-car">
        <div class="headlights"></div>
        <div class="headlights right"></div>
    </div>
    <div class="racing-car formula" style="animation-delay: 2s; bottom: 120px;"></div>
    <div class="racing-car" style="animation-delay: 4s; bottom: 80px;">
        <div class="headlights"></div>
        <div class="headlights right"></div>
    </div>
    
    <div class="container">
        <header>
            <h1><i class="fas fa-keyboard"></i> Key Racer - Typing Lessons <i class="fas fa-flag-checkered"></i></h1>
            <p class="header-text">Master your typing skills with our specialized lessons</p>
            <div class="feature-tabs">
                <a href="index.html" class="tab"><i class="fas fa-home"></i> Home</a>
                <a href="lessons.html" class="tab active"><i class="fas fa-graduation-cap"></i> Lessons</a>
                <a href="typing-tips.html" class="tab"><i class="fas fa-lightbulb"></i> Tips</a>
                <a href="leaderboard.html" class="tab"><i class="fas fa-trophy"></i> Leaderboard</a>
            </div>
        </header>

        <main>
            <div class="lesson-selector">
                <div class="lesson-category">
                    <h2><i class="fas fa-book"></i> Structured Lessons</h2>
                    <div class="lesson-grid">
                        <div class="lesson-card lesson-beginner" data-type="beginner">
                            <div class="lesson-icon">
                                <i class="fas fa-baby"></i>
                            </div>
                            <h3>Beginner</h3>
                            <p>One alphabet/character at a time. Focus on key familiarity and building muscle memory.</p>
                            <div class="lesson-level">
                                <span class="level-dot filled"></span>
                                <span class="level-dot"></span>
                                <span class="level-dot"></span>
                            </div>
                            <button class="start-lesson-btn">Begin Lesson</button>
                        </div>
                        
                        <div class="lesson-card lesson-intermediate" data-type="intermediate">
                            <div class="lesson-icon">
                                <i class="fas fa-running"></i>
                            </div>
                            <h3>Intermediate</h3>
                            <p>One word at a time. Focus on word recognition, typing speed, and accuracy.</p>
                            <div class="lesson-level">
                                <span class="level-dot filled"></span>
                                <span class="level-dot filled"></span>
                                <span class="level-dot"></span>
                            </div>
                            <button class="start-lesson-btn">Begin Lesson</button>
                        </div>
                        
                        <div class="lesson-card lesson-advanced" data-type="advanced">
                            <div class="lesson-icon">
                                <i class="fas fa-rocket"></i>
                            </div>
                            <h3>Advanced</h3>
                            <p>Full sentence practice with punctuation, capitalization, and numbers. Real-time WPM and accuracy tracking.</p>
                            <div class="lesson-level">
                                <span class="level-dot filled"></span>
                                <span class="level-dot filled"></span>
                                <span class="level-dot filled"></span>
                            </div>
                            <button class="start-lesson-btn">Begin Lesson</button>
                        </div>
                    </div>
                </div>
                
                <div class="lesson-category">
                    <h2><i class="fas fa-bolt"></i> Tricky Keys Challenge</h2>
                    <div class="lesson-grid">
                        <div class="lesson-card lesson-tricky" data-type="tricky-numbers">
                            <div class="lesson-icon">
                                <i class="fas fa-hashtag"></i>
                            </div>
                            <h3>Number Row</h3>
                            <p>Master those tricky numbers and symbols that often slow typists down.</p>
                            <div class="lesson-progress">
                                <div class="progress-bar">
                                    <div class="progress" style="width: 0%;"></div>
                                </div>
                                <span>0% Mastered</span>
                            </div>
                            <button class="start-lesson-btn">Practice Now</button>
                        </div>
                        
                        <div class="lesson-card lesson-tricky" data-type="tricky-special">
                            <div class="lesson-icon">
                                <i class="fas fa-percent"></i>
                            </div>
                            <h3>Special Characters</h3>
                            <p>Get familiar with brackets, quotes, and other special characters.</p>
                            <div class="lesson-progress">
                                <div class="progress-bar">
                                    <div class="progress" style="width: 0%;"></div>
                                </div>
                                <span>0% Mastered</span>
                            </div>
                            <button class="start-lesson-btn">Practice Now</button>
                        </div>
                        
                        <div class="lesson-card lesson-tricky" data-type="tricky-uncommon">
                            <div class="lesson-icon">
                                <i class="fas fa-puzzle-piece"></i>
                            </div>
                            <h3>Uncommon Combinations</h3>
                            <p>Practice letter combinations that are difficult to type quickly.</p>
                            <div class="lesson-progress">
                                <div class="progress-bar">
                                    <div class="progress" style="width: 0%;"></div>
                                </div>
                                <span>0% Mastered</span>
                            </div>
                            <button class="start-lesson-btn">Practice Now</button>
                        </div>
                    </div>
                </div>
                
                <div class="lesson-category">
                    <h2><i class="fas fa-fire"></i> Bigram Blitz</h2>
                    <p class="category-description">Bigrams are two-letter combinations that appear frequently in language. Mastering common bigrams significantly improves your typing speed.</p>
                    
                    <div class="bigram-container">
                        <div class="bigram-groups">
                            <div class="bigram-group active" data-group="common">
                                <h3>Common Bigrams</h3>
                                <div class="bigram-chips">
                                    <span class="bigram-chip">th</span>
                                    <span class="bigram-chip">he</span>
                                    <span class="bigram-chip">in</span>
                                    <span class="bigram-chip">er</span>
                                    <span class="bigram-chip">an</span>
                                    <span class="bigram-chip">re</span>
                                    <span class="bigram-chip">on</span>
                                    <span class="bigram-chip">at</span>
                                </div>
                            </div>
                            
                            <div class="bigram-group" data-group="difficult">
                                <h3>Challenging Bigrams</h3>
                                <div class="bigram-chips">
                                    <span class="bigram-chip">zx</span>
                                    <span class="bigram-chip">qw</span>
                                    <span class="bigram-chip">fp</span>
                                    <span class="bigram-chip">bv</span>
                                    <span class="bigram-chip">xc</span>
                                    <span class="bigram-chip">kj</span>
                                    <span class="bigram-chip">mn</span>
                                    <span class="bigram-chip">zt</span>
                                </div>
                            </div>
                            
                            <div class="bigram-group" data-group="custom">
                                <h3>Custom Practice</h3>
                                <div class="custom-bigram-input">
                                    <input type="text" id="custom-bigram" placeholder="Enter bigrams..." maxlength="20">
                                    <button id="add-custom-bigram" class="accent-btn btn-small">Add</button>
                                </div>
                                <div class="bigram-chips custom-chips">
                                    <!-- Custom bigrams will be added here by JavaScript -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="bigram-practice">
                            <h3>Bigram Blitz Challenge</h3>
                            <div class="bigram-stats">
                                <div class="stat">
                                    <span class="stat-value">0</span>
                                    <p>WPM</p>
                                </div>
                                <div class="stat">
                                    <span class="stat-value">0</span>
                                    <p>Accuracy</p>
                                </div>
                                <div class="stat">
                                    <span class="stat-value">0</span>
                                    <p>Streak</p>
                                </div>
                            </div>
                            <div class="bigram-display">
                                <div class="current-bigram">th</div>
                                <div class="next-bigrams">
                                    <span>he</span>
                                    <span>in</span>
                                    <span>er</span>
                                </div>
                            </div>
                            <input type="text" class="bigram-input" placeholder="Type the bigram above..." maxlength="2">
                            <div class="bigram-timer">
                                <div class="timer-bar">
                                    <div class="timer-progress"></div>
                                </div>
                                <span class="timer-text">60s</span>
                            </div>
                            <button class="start-bigram-btn primary-btn">Start Bigram Blitz</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Lesson Practice Area -->
            <div class="lesson-practice" style="display: none;">
                <div class="lesson-header">
                    <h2 id="lesson-title">Lesson Title</h2>
                    <button class="close-lesson-btn"><i class="fas fa-times"></i> Close Lesson</button>
                </div>
                
                <div class="lesson-content">
                    <div class="lesson-instructions">
                        <p id="lesson-description">Lesson description will appear here.</p>
                    </div>
                    
                    <div class="lesson-progress-indicator">
                        <div class="progress-steps">
                            <div class="step active">1</div>
                            <div class="step">2</div>
                            <div class="step">3</div>
                            <div class="progress-line">
                                <div class="progress-completed"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="typing-test-container">
                        <div class="text-display lesson-text-display" id="lesson-text-display"></div>
                        <textarea id="lesson-text-input" class="text-input" placeholder="Type the text above..."></textarea>
                    </div>
                    
                    <div class="keyboard-container">
                        <div class="keyboard" id="lesson-keyboard">
                            <!-- Keyboard will be generated by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="lesson-navigation">
                        <button class="nav-btn prev-btn" disabled><i class="fas fa-arrow-left"></i> Previous</button>
                        <button class="nav-btn next-btn">Next <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>
            </div>
            
            <!-- Completion Modal -->
            <div class="completion-modal" style="display: none;">
                <div class="modal-content">
                    <h2>Lesson Complete!</h2>
                    <div class="completion-stats">
                        <div class="completion-stat">
                            <span class="stat-value" id="completion-wpm">0</span>
                            <p>WPM</p>
                        </div>
                        <div class="completion-stat">
                            <span class="stat-value" id="completion-accuracy">0</span>
                            <p>Accuracy</p>
                        </div>
                        <div class="completion-stat">
                            <span class="stat-value" id="completion-time">0</span>
                            <p>Time (s)</p>
                        </div>
                    </div>
                    <div class="completion-message">
                        <p id="completion-feedback">Great job! You've completed this lesson successfully.</p>
                    </div>
                    <div class="completion-actions">
                        <button class="restart-lesson-btn">Restart Lesson</button>
                        <button class="next-lesson-btn">Next Lesson</button>
                        <button class="return-lessons-btn">Return to Lessons</button>
                    </div>
                </div>
            </div>
        </main>

        <footer>
            <p>&copy; 2025 Key Racer</p>
            <div class="footer-links-container">
                <div class="keyboard-links">
                    <a href="about.html" class="keyboard-key">About Us</a>
                    <a href="privacy-policy.html" class="keyboard-key">Privacy Policy</a>
                    <a href="terms-conditions.html" class="keyboard-key">Terms & Conditions</a>
                </div>
            </div>
        </footer>
    </div>

    <script src="scripts/keyboard.js"></script>
    <script src="scripts/database.js"></script>
    <script src="scripts/lessons.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // This script is a placeholder until the full lessons.js is implemented
            console.log('Lessons page loaded');
            
            // Initialize default progress for all tricky lessons
            const trickyLessons = document.querySelectorAll('.lesson-card[data-type^="tricky-"]');
            trickyLessons.forEach(function(card) {
                const progressBar = card.querySelector('.progress');
                const progressText = card.querySelector('.lesson-progress span');
                
                if (progressBar) progressBar.style.width = '0%';
                if (progressText) progressText.textContent = '0% Mastered';
            });
            
            // Try to load saved progress from localStorage
            try {
                const savedProgress = JSON.parse(localStorage.getItem('lessonProgress') || '{}');
                
                // Apply saved progress to each lesson
                Object.keys(savedProgress).forEach(function(lessonType) {
                    const progressPercentage = savedProgress[lessonType];
                    const lessonCard = document.querySelector(`.lesson-card[data-type="${lessonType}"]`);
                    
                    if (lessonCard) {
                        const progressBar = lessonCard.querySelector('.progress');
                        const progressText = lessonCard.querySelector('.lesson-progress span');
                        
                        if (progressBar) progressBar.style.width = `${progressPercentage}%`;
                        if (progressText) progressText.textContent = `${progressPercentage}% Mastered`;
                        console.log(`Loaded saved progress: ${lessonType} - ${progressPercentage}%`);
                    }
                });
            } catch (e) {
                console.error('Error loading saved progress:', e);
            }
            
            // Sample content for different lesson types
            const lessonContent = {
                beginner: {
                    title: "Character-by-Character Practice",
                    characters: "asdfjkl;ghqwertyuiopzxcvbnm1234567890",
                    description: "ðŸŸ¢ Beginner: One alphabet/character at a time. When you type correctly, the next character appears. Focus on key familiarity and building muscle memory."
                },
                intermediate: {
                    title: "Word-by-Word Practice",
                    words: ["the", "and", "that", "have", "for", "not", "with", "you", "this", "but", 
                            "his", "from", "they", "say", "her", "she", "will", "one", "all", "would", 
                            "there", "their", "what", "about", "which", "when", "make", "like", "time", "just"],
                    description: "ðŸŸ¡ Intermediate: One word at a time. Type the word, then the next word appears. Focus on word recognition, typing speed, and accuracy."
                },
                advanced: {
                    title: "Full Sentence Practice",
                    sentences: [
                        "The quick brown fox jumps over the lazy dog.",
                        "Pack my box with five dozen liquor jugs.",
                        "How vexingly quick daft zebras jump!",
                        "Sphinx of black quartz, judge my vow.",
                        "Amazingly few discotheques provide jukeboxes.",
                        "Crazy Fredrick bought many very exquisite opal jewels.",
                        "The five boxing wizards jump quickly.",
                        "We promptly judged antique ivory buckles for the next prize.",
                        "A wizard's job is to vex chumps quickly in fog.",
                        "Jackdaws love my big sphinx of quartz."
                    ],
                    description: "ðŸ”´ Advanced: Full sentence practice with timer. Includes real-time WPM tracking, accuracy percentage, and error highlighting. Uses punctuation, capitalization, and numbers for increased difficulty."
                },
                "tricky-numbers": {
                    title: "Number Row Challenge",
                    sequences: [
                        "1234567890",
                        "0987654321",
                        "12345 67890",
                        "1212 3434 5656 7878 9090",
                        "1010 2020 3030 4040",
                        "11 22 33 44 55 66 77 88 99 00",
                        "19 28 37 46 55 64 73 82 91",
                        "10293847 5647382910",
                        "1a2b3c 4d5e6f 7g8h9i0j",
                        "1! 2@ 3# 4$ 5% 6^ 7& 8* 9( 0)"
                    ],
                    description: "Practice typing numbers and symbols from the number row. Focus on building muscle memory for these often-neglected keys."
                },
                "tricky-special": {
                    title: "Special Characters Challenge",
                    sequences: [
                        "!@#$%^&*()",
                        "()[]{}<>",
                        "\"'`~,./:;-_+=\\|",
                        "Hello, world!",
                        "\"To be or not to be\"",
                        "(item1, item2, item3)",
                        "[array1, array2, array3]",
                        "{key1: value1, key2: value2}",
                        "a+b=c; x-y=z; m*n=o",
                        "file.txt, data.csv, image.png",
                        "https://www.example.com/path?query=value",
                        "/* This is a comment */"
                    ],
                    description: "Master special characters like brackets, quotes, and other symbols that often slow typists down."
                },
                "tricky-uncommon": {
                    title: "Uncommon Combinations Challenge",
                    sequences: [
                        "zx cv bn mk lp qw er ty ui op",
                        "xkcd zqpm wjvf btgh",
                        "rhythm myth crypt glyph",
                        "queue yacht plumb thumb",
                        "pneumonia psychology pterodactyl",
                        "xylophone synchronize paralysis",
                        "acquiesce acquisition acquaintance",
                        "mnemonic pneumatic pseudonym",
                        "bureaucracy conscientious idiosyncrasy",
                        "zwitterion quixotic juxtaposition"
                    ],
                    description: "Practice difficult letter combinations that don't frequently appear together to improve your overall typing fluency."
                }
            };
            
            // Handle lesson card clicks
            const lessonCards = document.querySelectorAll('.lesson-card');
            const lessonSelector = document.querySelector('.lesson-selector');
            const lessonPractice = document.querySelector('.lesson-practice');
            const closeLessonBtn = document.querySelector('.close-lesson-btn');
            const lessonTitle = document.getElementById('lesson-title');
            const lessonDescription = document.getElementById('lesson-description');
            
            // Variables to track typing progress
            let currentIndex = 0;
            let correctChars = 0;
            let incorrectChars = 0;
            let startTime = null;
            let lessonMode = "";
            let currentContent = "";
            let currentWordIndex = 0;
            let typingInterval;
            
            // Function to calculate WPM and accuracy
            function calculateMetrics() {
                if (!startTime) return { wpm: 0, accuracy: 100 };
                
                const timeElapsed = (Date.now() - startTime) / 60000; // in minutes
                const wpm = Math.round((correctChars / 5) / timeElapsed); // standard WPM calculation
                const accuracy = Math.round((correctChars / (correctChars + incorrectChars)) * 100);
                
                return { wpm, accuracy };
            }
            
            // Function to update metrics display
            function updateMetricsDisplay() {
                const metrics = calculateMetrics();
                
                // Only update if in advanced mode
                if (lessonMode === "advanced") {
                    const wpmDisplay = document.createElement('div');
                    wpmDisplay.className = 'live-metric';
                    wpmDisplay.innerHTML = `<strong>WPM:</strong> ${metrics.wpm}`;
                    
                    const accuracyDisplay = document.createElement('div');
                    accuracyDisplay.className = 'live-metric';
                    accuracyDisplay.innerHTML = `<strong>Accuracy:</strong> ${metrics.accuracy}%`;
                    
                    const metricsContainer = document.querySelector('.lesson-metrics') || document.createElement('div');
                    if (!document.querySelector('.lesson-metrics')) {
                        metricsContainer.className = 'lesson-metrics';
                        metricsContainer.style.cssText = 'position: absolute; top: 10px; right: 20px; background: rgba(0,0,0,0.7); padding: 10px; border-radius: 8px;';
                        document.querySelector('.typing-test-container').appendChild(metricsContainer);
                    }
                    
                    metricsContainer.innerHTML = '';
                    metricsContainer.appendChild(wpmDisplay);
                    metricsContainer.appendChild(accuracyDisplay);
                }
            }
            
            // Function to generate lesson content based on type
            function generateLessonContent(lessonType) {
                const textDisplay = document.getElementById('lesson-text-display');
                textDisplay.innerHTML = '';
                currentIndex = 0;
                correctChars = 0;
                incorrectChars = 0;
                startTime = null;
                
                if (lessonType === 'beginner') {
                    lessonMode = "beginner";
                    // For beginner, show one character at a time
                    currentContent = lessonContent.beginner.characters;
                    const span = document.createElement('span');
                    span.textContent = currentContent[0];
                    span.className = 'current';
                    textDisplay.appendChild(span);
                    
                } else if (lessonType === 'intermediate') {
                    lessonMode = "intermediate";
                    // For intermediate, show one word at a time
                    currentWordIndex = 0;
                    currentContent = lessonContent.intermediate.words;
                    const span = document.createElement('span');
                    span.textContent = currentContent[0];
                    span.className = 'current';
                    textDisplay.appendChild(span);
                    
                } else if (lessonType === 'advanced') {
                    lessonMode = "advanced";
                    // For advanced, show a full sentence with character spans
                    const randomIndex = Math.floor(Math.random() * lessonContent.advanced.sentences.length);
                    currentContent = lessonContent.advanced.sentences[randomIndex];
                    
                    // Create spans for each character in the sentence
                    for (let i = 0; i < currentContent.length; i++) {
                        const span = document.createElement('span');
                        span.textContent = currentContent[i];
                        if (i === 0) span.className = 'current';
                        textDisplay.appendChild(span);
                    }
                    
                    // Add metrics display for advanced mode
                    if (!document.querySelector('.lesson-metrics')) {
                        const metricsContainer = document.createElement('div');
                        metricsContainer.className = 'lesson-metrics';
                        metricsContainer.style.cssText = 'position: absolute; top: 10px; right: 20px; background: rgba(0,0,0,0.7); padding: 10px; border-radius: 8px;';
                        
                        const wpmDisplay = document.createElement('div');
                        wpmDisplay.className = 'live-metric';
                        wpmDisplay.innerHTML = '<strong>WPM:</strong> 0';
                        
                        const accuracyDisplay = document.createElement('div');
                        accuracyDisplay.className = 'live-metric';
                        accuracyDisplay.innerHTML = '<strong>Accuracy:</strong> 100%';
                        
                        metricsContainer.appendChild(wpmDisplay);
                        metricsContainer.appendChild(accuracyDisplay);
                        document.querySelector('.typing-test-container').appendChild(metricsContainer);
                    }
                    
                    // Start updating metrics every second for advanced mode
                    typingInterval = setInterval(updateMetricsDisplay, 1000);
                } else if (lessonType.startsWith('tricky-')) {
                    // Handle tricky challenges
                    lessonMode = "tricky";
                    
                    // Get the specific tricky content
                    if (lessonContent[lessonType]) {
                        // Choose a random sequence from the tricky content
                        const sequences = lessonContent[lessonType].sequences;
                        const randomIndex = Math.floor(Math.random() * sequences.length);
                        currentContent = sequences[randomIndex];
                        
                        // Create spans for each character in the sequence
                        for (let i = 0; i < currentContent.length; i++) {
                            const span = document.createElement('span');
                            span.textContent = currentContent[i];
                            if (i === 0) span.className = 'current';
                            textDisplay.appendChild(span);
                        }
                        
                        // Add a challenge title
                        const challengeTitle = document.createElement('div');
                        challengeTitle.className = 'challenge-title';
                        challengeTitle.textContent = lessonContent[lessonType].title;
                        challengeTitle.style.cssText = 'margin-bottom: 15px; color: var(--accent-color); font-size: 1.2rem; text-align: center;';
                        textDisplay.parentNode.insertBefore(challengeTitle, textDisplay);
                        
                        // Add metrics display for tricky mode
                        if (!document.querySelector('.lesson-metrics')) {
                            const metricsContainer = document.createElement('div');
                            metricsContainer.className = 'lesson-metrics';
                            metricsContainer.style.cssText = 'position: absolute; top: 10px; right: 20px; background: rgba(0,0,0,0.7); padding: 10px; border-radius: 8px;';
                            
                            const wpmDisplay = document.createElement('div');
                            wpmDisplay.className = 'live-metric';
                            wpmDisplay.innerHTML = '<strong>WPM:</strong> 0';
                            
                            const accuracyDisplay = document.createElement('div');
                            accuracyDisplay.className = 'live-metric';
                            accuracyDisplay.innerHTML = '<strong>Accuracy:</strong> 100%';
                            
                            const progressDisplay = document.createElement('div');
                            progressDisplay.className = 'live-metric';
                            progressDisplay.innerHTML = '<strong>Progress:</strong> 1/' + sequences.length;
                            
                            metricsContainer.appendChild(wpmDisplay);
                            metricsContainer.appendChild(accuracyDisplay);
                            metricsContainer.appendChild(progressDisplay);
                            document.querySelector('.typing-test-container').appendChild(metricsContainer);
                        }
                        
                        // Start updating metrics every second for tricky mode
                        typingInterval = setInterval(updateMetricsDisplay, 1000);
                    }
                }
            }
            
            // Handle input for different lesson modes
            function handleLessonInput(e) {
                const textInput = document.getElementById('lesson-text-input');
                const textDisplay = document.getElementById('lesson-text-display');
                
                // Start timer on first keypress
                if (startTime === null) {
                    startTime = Date.now();
                }
                
                if (lessonMode === "beginner") {
                    // For beginner: check if the typed character matches the current character
                    const typedChar = e.key;
                    
                    if (typedChar === currentContent[currentIndex]) {
                        // Correct character
                        correctChars++;
                        currentIndex++;
                        
                        if (currentIndex < currentContent.length) {
                            // Show next character
                            textDisplay.innerHTML = '';
                            const span = document.createElement('span');
                            span.textContent = currentContent[currentIndex];
                            span.className = 'current';
                            textDisplay.appendChild(span);
                        } else {
                            // End of character set, loop back
                            currentIndex = 0;
                            textDisplay.innerHTML = '';
                            const span = document.createElement('span');
                            span.textContent = currentContent[currentIndex];
                            span.className = 'current';
                            textDisplay.appendChild(span);
                        }
                    } else {
                        // Incorrect character
                        incorrectChars++;
                        textDisplay.querySelector('.current').classList.add('error');
                        setTimeout(() => {
                            textDisplay.querySelector('.current').classList.remove('error');
                        }, 300);
                    }
                    
                    // Clear input field
                    textInput.value = '';
                    
                } else if (lessonMode === "intermediate") {
                    // For intermediate: check if the typed word matches the current word
                    if (e.key === ' ' || e.key === 'Enter') {
                        const typedWord = textInput.value.trim();
                        
                        if (typedWord === currentContent[currentWordIndex]) {
                            // Correct word
                            correctChars += currentContent[currentWordIndex].length;
                            currentWordIndex++;
                            
                            if (currentWordIndex < currentContent.length) {
                                // Show next word
                                textDisplay.innerHTML = '';
                                const span = document.createElement('span');
                                span.textContent = currentContent[currentWordIndex];
                                span.className = 'current';
                                textDisplay.appendChild(span);
                            } else {
                                // End of word set, loop back
                                currentWordIndex = 0;
                                textDisplay.innerHTML = '';
                                const span = document.createElement('span');
                                span.textContent = currentContent[currentWordIndex];
                                span.className = 'current';
                                textDisplay.appendChild(span);
                            }
                        } else {
                            // Incorrect word
                            incorrectChars += currentContent[currentWordIndex].length;
                            textDisplay.querySelector('.current').classList.add('error');
                            setTimeout(() => {
                                textDisplay.querySelector('.current').classList.remove('error');
                            }, 300);
                        }
                        
                        // Clear input field
                        textInput.value = '';
                        e.preventDefault();
                    }
                    
                } else if (lessonMode === "advanced" || lessonMode === "tricky") {
                    // For advanced and tricky: check character by character
                    const chars = textDisplay.querySelectorAll('span');
                    
                    if (e.key === 'Backspace') {
                        if (currentIndex > 0) {
                            currentIndex--;
                            chars[currentIndex].classList.remove('correct', 'incorrect');
                            chars[currentIndex].classList.add('current');
                            if (currentIndex + 1 < chars.length) {
                                chars[currentIndex + 1].classList.remove('current');
                            }
                        }
                    } else if (e.key.length === 1) {
                        if (currentIndex < chars.length) {
                            // Remove current class
                            chars[currentIndex].classList.remove('current');
                            
                            // Check if character is correct
                            if (e.key === chars[currentIndex].textContent) {
                                chars[currentIndex].classList.add('correct');
                                correctChars++;
                            } else {
                                chars[currentIndex].classList.add('incorrect');
                                incorrectChars++;
                            }
                            
                            // Move to next character
                            currentIndex++;
                            if (currentIndex < chars.length) {
                                chars[currentIndex].classList.add('current');
                            } else {
                                // End of sequence
                                clearInterval(typingInterval);
                                
                                // For tricky mode, show next sequence or completion
                                if (lessonMode === "tricky") {
                                    const lessonType = document.querySelector('.lesson-practice').dataset.lessonType;
                                    const sequences = lessonContent[lessonType].sequences;
                                    const currentSequenceIndex = parseInt(document.querySelector('.lesson-practice').dataset.sequenceIndex || "0");
                                    
                                    if (currentSequenceIndex < sequences.length - 1) {
                                        // Show next sequence
                                        document.querySelector('.lesson-practice').dataset.sequenceIndex = currentSequenceIndex + 1;
                                        
                                        // Update progress display
                                        const progressDisplay = document.querySelector('.lesson-metrics .live-metric:nth-child(3)');
                                        if (progressDisplay) {
                                            progressDisplay.innerHTML = `<strong>Progress:</strong> ${currentSequenceIndex + 2}/${sequences.length}`;
                                        }
                                        
                                        // Generate next sequence
                                        textDisplay.innerHTML = '';
                                        currentContent = sequences[currentSequenceIndex + 1];
                                        currentIndex = 0;
                                        
                                        // Create spans for each character in the sequence
                                        for (let i = 0; i < currentContent.length; i++) {
                                            const span = document.createElement('span');
                                            span.textContent = currentContent[i];
                                            if (i === 0) span.className = 'current';
                                            textDisplay.appendChild(span);
                                        }
                                        
                                        // Restart metrics tracking
                                        typingInterval = setInterval(updateMetricsDisplay, 1000);
                                    } else {
                                        // All sequences completed
                                        const metrics = calculateMetrics();
                                        showCompletionModal(metrics.wpm, metrics.accuracy);
                                        
                                        // Update progress for tricky lessons
                                        updateTrickyProgress(lessonType);
                                    }
                                } else {
                                    // For advanced mode, show completion
                                    const metrics = calculateMetrics();
                                    showCompletionModal(metrics.wpm, metrics.accuracy);
                                }
                            }
                        }
                    }
                    
                    // Prevent default behavior for advanced and tricky modes to avoid text input
                    e.preventDefault();
                    
                    // Update metrics
                    updateMetricsDisplay();
                }
            }
            
            // Function to show completion modal
            function showCompletionModal(wpm, accuracy) {
                const completionModal = document.querySelector('.completion-modal');
                document.getElementById('completion-wpm').textContent = wpm;
                document.getElementById('completion-accuracy').textContent = accuracy;
                document.getElementById('completion-time').textContent = Math.round((Date.now() - startTime) / 1000);
                
                // Generate feedback based on performance
                let feedback = "Great job!";
                if (wpm > 60) {
                    feedback += " Your typing speed is excellent!";
                } else if (wpm > 40) {
                    feedback += " Your typing speed is good, keep practicing!";
                } else {
                    feedback += " Keep practicing to improve your speed.";
                }
                
                if (accuracy > 95) {
                    feedback += " Your accuracy is outstanding!";
                } else if (accuracy > 85) {
                    feedback += " Your accuracy is good.";
                } else {
                    feedback += " Focus on accuracy before speed.";
                }
                
                document.getElementById('completion-feedback').textContent = feedback;
                completionModal.style.display = 'flex';
            }
            
            // Function to update progress for tricky lessons
            function updateTrickyProgress(lessonType) {
                // Find the lesson card
                const lessonCard = document.querySelector(`.lesson-card[data-type="${lessonType}"]`);
                if (lessonCard) {
                    // Get current progress
                    const progressText = lessonCard.querySelector('.lesson-progress span');
                    const currentText = progressText ? progressText.textContent : "0% Mastered";
                    const currentPercentage = parseInt(currentText) || 0;
                    
                    // Increment by 33% (up to 100%)
                    const progressPercentage = Math.min(currentPercentage + 33, 100);
                    
                    // Update the UI
                    const progressBar = lessonCard.querySelector('.progress');
                    
                    if (progressBar) progressBar.style.width = `${progressPercentage}%`;
                    if (progressText) progressText.textContent = `${progressPercentage}% Mastered`;
                    
                    // Save progress to localStorage
                    try {
                        const progressData = JSON.parse(localStorage.getItem('lessonProgress') || '{}');
                        progressData[lessonType] = progressPercentage;
                        localStorage.setItem('lessonProgress', JSON.stringify(progressData));
                        console.log(`Progress saved: ${lessonType} - ${progressPercentage}%`);
                    } catch (e) {
                        console.error('Error saving progress to localStorage:', e);
                    }
                }
            }
            
            lessonCards.forEach(card => {
                card.querySelector('.start-lesson-btn').addEventListener('click', function() {
                    const lessonType = card.dataset.type;
                    const lessonName = card.querySelector('h3').textContent;
                    
                    // Show lesson practice area
                    lessonSelector.style.display = 'none';
                    lessonPractice.style.display = 'block';
                    
                    // Set data attributes for tracking progress
                    lessonPractice.dataset.lessonType = lessonType;
                    lessonPractice.dataset.lessonIndex = 0;
                    lessonPractice.dataset.stepIndex = 0;
                    lessonPractice.dataset.sequenceIndex = 0; // For tracking tricky challenges
                    
                    // Update lesson title and description
                    lessonTitle.textContent = lessonName;
                    
                    // Set lesson description based on type
                    switch(lessonType) {
                        case 'beginner':
                            lessonDescription.textContent = lessonContent.beginner.description;
                            break;
                        case 'intermediate':
                            lessonDescription.textContent = lessonContent.intermediate.description;
                            break;
                        case 'advanced':
                            lessonDescription.textContent = lessonContent.advanced.description;
                            break;
                        case 'tricky-numbers':
                            lessonDescription.textContent = lessonContent['tricky-numbers'].description;
                            break;
                        case 'tricky-special':
                            lessonDescription.textContent = lessonContent['tricky-special'].description;
                            break;
                        case 'tricky-uncommon':
                            lessonDescription.textContent = lessonContent['tricky-uncommon'].description;
                            break;
                        default:
                            lessonDescription.textContent = 'Follow the instructions and type the text shown below.';
                    }
                    
                    // Generate lesson content based on type
                    generateLessonContent(lessonType);
                    
                    // Set up input handling
                    const textInput = document.getElementById('lesson-text-input');
                    textInput.value = '';
                    textInput.disabled = false;
                    textInput.focus();
                    
                    // Add event listener for input
                    textInput.addEventListener('keydown', handleLessonInput);
                    
                    // Initialize the keyboard if not already done
                    if (typeof initKeyboard === 'function') {
                        initKeyboard('lesson-keyboard');
                    }
                });
            });
            
            // Handle close lesson button
            closeLessonBtn.addEventListener('click', function() {
                // Get current lesson data
                const practiceArea = document.querySelector('.lesson-practice');
                const lessonType = practiceArea.dataset.lessonType;
                
                // Clear any intervals
                if (typingInterval) {
                    clearInterval(typingInterval);
                }
                
                // Remove event listeners
                document.getElementById('lesson-text-input').removeEventListener('keydown', handleLessonInput);
                
                // Update progress for tricky lessons
                if (lessonType && lessonType.startsWith('tricky-')) {
                    // Find the lesson card
                    const lessonCard = document.querySelector(`.lesson-card[data-type="${lessonType}"]`);
                    if (lessonCard) {
                        // Set progress to 33% (completed 1/3 of the lesson)
                        const progressBar = lessonCard.querySelector('.progress');
                        const progressText = lessonCard.querySelector('.lesson-progress span');
                        
                        if (progressBar) progressBar.style.width = '33%';
                        if (progressText) progressText.textContent = '33% Mastered';
                    }
                }
                
                // Close the lesson
                lessonPractice.style.display = 'none';
                lessonSelector.style.display = 'block';
            });
            
            // Add CSS for typing interface
            const styleElement = document.createElement('style');
            styleElement.textContent = `
                .current { 
                    background-color: rgba(0, 255, 221, 0.2);
                    border-bottom: 2px solid var(--accent-color);
                    color: white;
                }
                .correct { color: #00ffdd; }
                .incorrect { color: #ff4040; text-decoration: underline; }
                .error { animation: shake 0.3s; color: #ff4040; }
                @keyframes shake {
                    0% { transform: translateX(0); }
                    25% { transform: translateX(-5px); }
                    50% { transform: translateX(5px); }
                    75% { transform: translateX(-5px); }
                    100% { transform: translateX(0); }
                }
                .lesson-text-display {
                    font-size: 24px;
                    line-height: 1.5;
                    letter-spacing: 1px;
                }
                .completion-modal {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.7);
                    display: none;
                    justify-content: center;
                    align-items: center;
                    z-index: 1000;
                }
            `;
            document.head.appendChild(styleElement);
            
            // Handle bigram group tabs
            const bigramGroups = document.querySelectorAll('.bigram-group');
            bigramGroups.forEach(group => {
                group.addEventListener('click', function() {
                    bigramGroups.forEach(g => g.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            // Start Bigram Blitz button
            const startBigramBtn = document.querySelector('.start-bigram-btn');
            let bigramBlitzActive = false;
            let bigramTimer;
            
            startBigramBtn.addEventListener('click', function() {
                if (!bigramBlitzActive) {
                    // Start the game
                    bigramBlitzActive = true;
                    startBigramBtn.textContent = 'Stop Challenge';
                    
                    // Enable input and focus it
                    const bigramInput = document.querySelector('.bigram-input');
                    bigramInput.disabled = false;
                    bigramInput.focus();
                    
                    // Reset stats
                    document.querySelectorAll('.bigram-stats .stat-value').forEach(stat => {
                        stat.textContent = '0';
                    });
                    
                    // Start the timer animation
                    const timerProgress = document.querySelector('.timer-progress');
                    timerProgress.style.width = '100%';
                    timerProgress.style.transition = 'width 60s linear';
                    
                    // Update timer text
                    let timeLeft = 60;
                    const timerText = document.querySelector('.timer-text');
                    
                    bigramTimer = setInterval(() => {
                        timeLeft--;
                        timerText.textContent = timeLeft + 's';
                        
                        if (timeLeft <= 0) {
                            // End the game
                            clearInterval(bigramTimer);
                            bigramBlitzActive = false;
                            startBigramBtn.textContent = 'Start Bigram Blitz';
                            bigramInput.disabled = true;
                            timerProgress.style.width = '0%';
                            timerProgress.style.transition = 'none';
                            
                            // Show a simple completion message
                            alert('Time\'s up! You completed the Bigram Blitz challenge.');
                        }
                    }, 1000);
                } else {
                    // Stop the game
                    clearInterval(bigramTimer);
                    bigramBlitzActive = false;
                    startBigramBtn.textContent = 'Start Bigram Blitz';
                    
                    // Disable input
                    const bigramInput = document.querySelector('.bigram-input');
                    bigramInput.disabled = true;
                    
                    // Reset timer
                    const timerProgress = document.querySelector('.timer-progress');
                    timerProgress.style.width = '0%';
                    timerProgress.style.transition = 'none';
                    document.querySelector('.timer-text').textContent = '60s';
                }
            });
            
            // Custom bigram feature
            const addCustomBigramBtn = document.getElementById('add-custom-bigram');
            const customBigramInput = document.getElementById('custom-bigram');
            const customChips = document.querySelector('.custom-chips');
            
            addCustomBigramBtn.addEventListener('click', function() {
                const value = customBigramInput.value.trim().toLowerCase();
                
                // Validate input: must be exactly 2 letters
                if (value.length === 2 && /^[a-z]{2}$/.test(value)) {
                    // Create and add the chip
                    const chip = document.createElement('span');
                    chip.className = 'bigram-chip';
                    chip.textContent = value;
                    customChips.appendChild(chip);
                    
                    // Clear input
                    customBigramInput.value = '';
                    
                    // Add click event to remove the chip
                    chip.addEventListener('click', function() {
                        chip.remove();
                    });
                } else {
                    alert('Please enter exactly 2 letters (a-z).');
                }
            });
            
            // Allow pressing Enter to add a custom bigram
            customBigramInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addCustomBigramBtn.click();
                }
            });
            
            // Add progress update to completion modal buttons
            const restartBtn = document.querySelector('.restart-lesson-btn');
            const nextLessonBtn = document.querySelector('.next-lesson-btn');
            const returnBtn = document.querySelector('.return-lessons-btn');
            
            if (restartBtn && nextLessonBtn && returnBtn) {
                // Function to update progress
                function updateProgress(increment = true) {
                    const practiceArea = document.querySelector('.lesson-practice');
                    const lessonType = practiceArea.dataset.lessonType;
                    
                    if (lessonType && lessonType.startsWith('tricky-')) {
                        // Find the lesson card
                        const lessonCard = document.querySelector(`.lesson-card[data-type="${lessonType}"]`);
                        if (lessonCard) {
                            // Set progress (using a different percentage based on which button was clicked)
                            let progressPercentage = 33; // Default progress
                            
                            if (increment) {
                                // Check current progress
                                const currentText = lessonCard.querySelector('.lesson-progress span').textContent;
                                const currentPercentage = parseInt(currentText) || 0;
                                
                                // Increment by 33% (up to 100%)
                                progressPercentage = Math.min(currentPercentage + 33, 100);
                            }
                            
                            // Update the UI
                            const progressBar = lessonCard.querySelector('.progress');
                            const progressText = lessonCard.querySelector('.lesson-progress span');
                            
                            if (progressBar) progressBar.style.width = `${progressPercentage}%`;
                            if (progressText) progressText.textContent = `${progressPercentage}% Mastered`;
                            
                            // Save progress to localStorage
                            try {
                                const progressData = JSON.parse(localStorage.getItem('lessonProgress') || '{}');
                                progressData[lessonType] = progressPercentage;
                                localStorage.setItem('lessonProgress', JSON.stringify(progressData));
                                console.log(`Progress saved: ${lessonType} - ${progressPercentage}%`);
                            } catch (e) {
                                console.error('Error saving progress to localStorage:', e);
                            }
                        }
                    }
                }
                
                // Add event listeners to buttons
                restartBtn.addEventListener('click', function() {
                    // When restarting, don't increase progress
                    updateProgress(false);
                    document.querySelector('.completion-modal').style.display = 'none';
                });
                
                nextLessonBtn.addEventListener('click', function() {
                    // When moving to next lesson, increase progress
                    updateProgress(true);
                    document.querySelector('.completion-modal').style.display = 'none';
                });
                
                returnBtn.addEventListener('click', function() {
                    // When returning to lessons page, increase progress
                    updateProgress(true);
                    document.querySelector('.completion-modal').style.display = 'none';
                });
            }
        });
    </script>
</body>
</html> 